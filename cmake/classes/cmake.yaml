buildVars: [CFLAGS, CXXFLAGS, LDFLAGS]
buildTools: [cmake]

# Bash
# ====

buildScriptBash: |
   CMAKE_SRC_PATH="$1"
   CMAKE_DEP_PATHS=( "${@:2}" )

   cmakeBuildAll()
   {
      mkdir -p build dist
      local SRC="${1:-$CMAKE_SRC_PATH}"
      local CMAKE_PREFIX_PATH=
      local i

      for i in "${CMAKE_DEP_PATHS[@]}" ; do
         CMAKE_PREFIX_PATH="${CMAKE_PREFIX_PATH:+$CMAKE_PREFIX_PATH;}$(cygpath -w "$i")"
      done

      pushd build
      cmake $SRC \
         -DCMAKE_INSTALL_PREFIX= \
         ${CMAKE_PREFIX_PATH:+"-DCMAKE_PREFIX_PATH=${CMAKE_PREFIX_PATH}"}
      cmake --build . --config Debug
      DESTDIR="$PWD/../dist" cmake --install . --config Debug
      popd
   }

packageScriptBash: |
   CMAKE_BUILD_PATH="$1"

   cmakePackageAll()
   {
      cp -a "${1:-$CMAKE_BUILD_PATH}/dist"/* .
   }

# PowerShell
# ==========

buildVars: [BOB_HOST_PLATFORM]
buildScriptPwsh: |
        $cmakeSrcPath=$args[0]
        $cmakeDepPaths=$args[1..$args.length]

        function cmakeBuildAll()
        {
                param (
                        [string]$src = $cmakeSrcPath,
                        [string[]]$cmakeOptions = @()
                )

                New-Item -ItemType "directory" -Path build -Force
                New-Item -ItemType "directory" -Path dist -Force

                $cmakePrefixPath=""
                foreach ($i in $cmakeDepPaths) {
                        if ($cmakePrefixPath -ne "") {
                                $cmakePrefixPath += ";"
                        }
                        $cmakePrefixPath += $i
                }

                pushd build
                if ($Env:BOB_HOST_PLATFORM -eq "win32") {
                   Check-Command {
                           cmake $src `
                                   "-DCMAKE_INSTALL_PREFIX=" `
                                   "-DCMAKE_PREFIX_PATH=$cmakePrefixPath"
                   }
                   Check-Command { cmake --build . --config Debug }
                   Check-Command { cmake --install . --config Debug --prefix "$PWD/../dist" }
                } else {
                   Check-Command {
                           cmake $src `
                                   "-DCMAKE_INSTALL_PREFIX=/usr" `
                                   "-DCMAKE_FIND_ROOT_PATH=$cmakePrefixPath"
                   }
                   Check-Command { cmake --build . --config Debug }
                   Check-Command { cmake --install . --config Debug --prefix "$PWD/../dist" }
                }
                popd
        }

packageScriptPwsh: |
        $cmakeBuildPath=$args[0]

        function cmakePackageAll()
        {
                param (
                        [string]$build = $cmakeBuildPath
                )

                Copy-Item -Path ($build + "/dist/*") -Destination . -Recurse
        }

