buildTools: [cmake]
buildVars: [BOB_HOST_PLATFORM, CFLAGS, CXXFLAGS, LDFLAGS]

# Bash
# ====

buildScriptBash: |
   CMAKE_SRC_PATH="$1"
   CMAKE_DEP_PATHS=( "${@:2}" )

   cmakeBuildAll()
   {
      local SRC="${1:-$CMAKE_SRC_PATH}"
      local deps=
      local i

      mkdir -p build dist
      pushd build
      if [[ $BOB_HOST_PLATFORM == win32 ]] ; then
         for i in "${CMAKE_DEP_PATHS[@]}" ; do
            deps="${deps:+$deps;}$(cygpath -w "$i")"
         done

         cmake $SRC \
            -DCMAKE_INSTALL_PREFIX= \
            ${deps:+"-DCMAKE_PREFIX_PATH=$deps"}
         cmake --build . --config Debug
         cmake --install . --config Debug --prefix "$PWD/../dist"
      else
         for i in "${CMAKE_DEP_PATHS[@]}" ; do
            deps="${deps:+$deps;}$i"
         done

         cmake $SRC \
            -DCMAKE_INSTALL_PREFIX=/usr \
            ${deps:+"-DCMAKE_FIND_ROOT_PATH=$deps"}
         cmake --build .
         DESTDIR="$PWD/../dist" cmake --install .
      fi
      popd
   }

packageScriptBash: |
   CMAKE_BUILD_PATH="$1"

   cmakePackageAll()
   {
      cp -a "${1:-$CMAKE_BUILD_PATH}/dist"/* .
   }

# PowerShell
# ==========

buildScriptPwsh: |
        $cmakeSrcPath=$args[0]
        $cmakeDepPaths=$args[1..$args.length]

        function cmakeBuildAll()
        {
                param (
                        [string]$src = $cmakeSrcPath,
                        [string[]]$cmakeOptions = @()
                )

                New-Item -ItemType "directory" -Path build -Force
                New-Item -ItemType "directory" -Path dist -Force

                $cmakePrefixPath=""
                foreach ($i in $cmakeDepPaths) {
                        if ($cmakePrefixPath -ne "") {
                                $cmakePrefixPath += ";"
                        }
                        $cmakePrefixPath += $i
                }

                pushd build
                if ($Env:BOB_HOST_PLATFORM -eq "win32") {
                   Check-Command {
                           cmake $src `
                                   "-DCMAKE_INSTALL_PREFIX=" `
                                   "-DCMAKE_PREFIX_PATH=$cmakePrefixPath"
                   }
                   Check-Command { cmake --build . --config Debug }
                   Check-Command { cmake --install . --config Debug --prefix "$PWD/../dist" }
                } else {
                   Check-Command {
                           cmake $src `
                                   "-DCMAKE_INSTALL_PREFIX=/usr" `
                                   "-DCMAKE_FIND_ROOT_PATH=$cmakePrefixPath"
                   }
                   Check-Command { cmake --build . }
                   $Env:DESTDIR="$PWD/../dist"
                   Check-Command { cmake --install . }
                }
                popd
        }

packageScriptPwsh: |
        $cmakeBuildPath=$args[0]

        function cmakePackageAll()
        {
                param (
                        [string]$build = $cmakeBuildPath
                )

                Copy-Item -Path ($build + "/dist/*") -Destination . -Recurse
        }

